## Grid Generation Code


##### Function to generate grid

Col = colorRampPalette(colors=c("blue","grey","red"))
#install.packages("RandomFields")
library(RandomFields)

createomegagrid<- function(Ngrid, Nu){
  SpatialSimModel = "Matern"
  Ngrid = Ngrid
  Nu = Nu
  loc_grid = expand.grid( "x"=seq(0,1,length=Ngrid), "y"=seq(0,1,length=Ngrid) )
  
  Col = colorRampPalette(colors=c("blue","grey","red"))
  X = c(0.183, 0.565, 0.625)
  Y = c(0.586, 0.182, 0.231)
  # Seed = Sys.time() ## can i do this?
  # Seed = Seed + 1
  # set.seed(Seed)
  # 
  #png( file=paste(File,"RandomFields -- explained.png",sep=""), width=6, height=6, res=200, units="in")
  #par(mfrow=c(2,1), mar=c(3,3,0.5,0.5), mgp=c(1.5,0.5,0), tck=-0.02, oma=c(2,2,0,0))
  for(RowI in 1:2){
    #    if(RowI==1) { Var=0.5; Scale=0.25 }
    #    if(RowI==2) { Var=1; Scale=0.1 }
    # set.seed(Seed)
    if(RowI==1) { Var=2; Scale=0.2 }
    if(RowI==2) { Var=2; Scale=0.2 }
    model_O <- RMmatern(nu=Nu, var=Var, scale=Scale)
    Omega_samp = RFsimulate(model=model_O, x=loc_grid[,'x'], y=loc_grid[,'y'])@data[,1]
    Omega_grid = matrix(Omega_samp, Ngrid, Ngrid)
    # image( Omega_grid, col=Col(n=10), xlab="Eastings", ylab="Northings", zlim=c(-3.5,3.5) )
    Dist = dist( cbind(X,Y) )
    # points( x=X, y=Y, cex=2, pch=c("A","B","C"))
    # plot(model_O, ylim=c(0,1.1), xlim=c(0,sqrt(2)), ylab="Covariance = f(distance)", xlab="distance", main="", xaxs="i", yaxs="i", lwd=2, col="black")
    h = seq(0,3,length=1e5)
    if(SpatialSimModel=="Matern") Cor = 2^(1-Nu) * gamma(Nu)^(-1) * (sqrt(2*Nu)*h/Scale)^Nu * besselK(sqrt(2*Nu) * h/Scale, nu=Nu)
    Cov = Cor * Var
    # plot( x=h, y=(Cov), type="l", xlim=c(0,1.4), xaxs="i", yaxs="i", ylim=c(0,1.2) )
    # abline(v=Dist, col=grey(0.1), lty="dotted")
    # text(x=Dist, y=0.9-c(0,0.07,0.14), labels=c("AB","AC","BC"))
    # Caclulate and print range
    kappa = sqrt(2*Nu)/Scale
    # print( paste("Kappa=", kappa ))
    # print( paste("Exact range=", abs(h[which.min( (Cor-0.10)^2 )])))
    # print( paste("Approx. range=", sqrt(8*Nu) / kappa ))
    # print( paste("Scale=", Scale ))
    return(Omega_grid)
  }
}



#### Generating many grids



# Collumn 1: seed 1
# Collumn 2: seed 2
# Collumn 3: correlation between grids

numgrid<- 10

row<- 0

seedseedcor<- matrix(data = NA, nrow = 100000, ncol = 3)

for(i in 1:200){
  species1seed<- i
  for(j in 400:600){
    row<- row + 1
    print(row)
    
    species2seed<- j
    
    seedseedcor[row, 1]<- species1seed
    seedseedcor[row, 2]<- species2seed
    
    set.seed(i)
    species1grid<- createomegagrid(Ngrid = numgrid, Nu = sample(x = seq(from = .0001, to = .8,
                                                                        length.out = 800),
                                                                size = 1))
    set.seed(j)
    species2grid<- createomegagrid(Ngrid = numgrid, Nu = sample(x = seq(from = .0001, to = .8,
                                                                        length.out = 800), 
                                                                size = 1))
    
    seedseedcor[row, 3]<- cor(c(species1grid), c(species2grid))
    
  }
}

write.table(seedseedcor, file = "Grid seeds and their correlation", sep = "\t",
            row.names = FALSE, col.names = TRUE)

plot(x = 1:40200, y = seedseedcor[1:40200,3], ylab = "correlation", xlab= "index")

min(seedseedcor[1:40200,3]) #-0.6201365
max(seedseedcor[1:40200,3]) #0.6332929
mean(seedseedcor[1:40200,3]) #4.640087e-05
median(seedseedcor[1:40200,3]) #0.0003176687
quantile(seedseedcor[1:40200,3]) 
#  0%           25%           50%           75%          100% 
# -0.6201364627 -0.1045187022  0.0003176687  0.1037285309  0.6332929087 

#REMOVE NAs

gridseeds<- seedseedcor[is.na(seedseedcor[,3])!= T,]

write.table(gridseeds, file = "Grid seeds and their correlation", sep = " ",
            row.names = FALSE, col.names = FALSE)

#could look into writing these as csvs instead!!!!!

gridseeds<- read.table("Grid seeds and their correlation")

#bins

# Correlation from -.5 to -.3

Bin1<- gridseeds[gridseeds[,3] <= -.3 & gridseeds[,3] >= -.5, ]

nrow(Bin1) #1144

# Correlation from -.3 to -.1

Bin2<- gridseeds[gridseeds[,3] <= -.1 & gridseeds[,3] >= -.3, ]

nrow(Bin2) #9246

# Correlation from -.1 to .1

Bin3<- gridseeds[gridseeds[,3] <= .1 & gridseeds[,3] >= -.1, ]

nrow(Bin3) #19415

# Correlation from .1 to .3

Bin4<- gridseeds[gridseeds[,3] <= .3 & gridseeds[,3] >= .1, ]

nrow(Bin4) #9187

# Correlation from .3 to .5

Bin5<- gridseeds[gridseeds[,3] <= .5 & gridseeds[,3] >= .3, ]

nrow(Bin5) #1139


# take 100 grids from each correlation range

Bin1subset<- Bin1[sample(x = 1:nrow(Bin1), size = 100, replace = FALSE),]
Bin2subset<- Bin2[sample(x = 1:nrow(Bin2), size = 100, replace = FALSE),]
Bin3subset<- Bin3[sample(x = 1:nrow(Bin3), size = 100, replace = FALSE),]
Bin4subset<- Bin4[sample(x = 1:nrow(Bin4), size = 100, replace = FALSE),]
Bin5subset<- Bin5[sample(x = 1:nrow(Bin5), size = 100, replace = FALSE),]

Binssubset<- rbind(Bin1subset, Bin2subset, Bin3subset, Bin4subset, Bin5subset)

write.table(Binssubset, file = "Subset of correlation grid seeds 100 each bin", sep = " ",
            row.names = FALSE, col.names = FALSE)

head(Binssubset)
nrow(Binssubset)

help<- read.table("Subset of correlation grid seeds 100 each bin")

?write.table
