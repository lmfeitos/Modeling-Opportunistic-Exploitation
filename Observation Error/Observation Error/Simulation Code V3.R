#################
#################
## Updated August 14 2019
## requires GWDD movement file
## requires parameter file
## requires grid generations

source("Functions - GWDD movement fix_sel1.R")
source("Parameters File Base LPS (1).R")

help<- read.table("Subset of correlation grid seeds 100 each bin")
Binssubset<- help

#run 500 simulations for 50 price ratios
nsims<- 500
numgrid<- 10

nratios<- 50
observvec<- seq(from = 0, to = .15, length.out = nratios)

###############################


allrunsfisp1<- matrix(NA, nrow = nsims, ncol = nratios)
allrunsfisp2<- matrix(NA, nrow = nsims, ncol = nratios)

plottingmatrix1<- matrix(NA, nrow = nratios, ncol = 13, byrow = FALSE)
#Collumn 1: correlation between original grids
#Collumn 2: species 1 mean f/i
#Collumn 3: species 2 mean f/i
#Collumn 4: price ratio
#column 5: number of poachers
#collumn 6: sd species 1 f/i
#collumn 7: sd species 2 f/i
#collumn 8: sp1 median f/i
#collumn 9: sp2 median f/i
#collumn 10: sp1 lower ci
#collumn 11: sp2 lower ci
#collumn 12: sp1 upper ci
#collumn 13: sp2 upper ci

## to plot correlations
correlationplot<- matrix(NA, nrow = (nsims * nratios), ncol = 5)
#col 1 = correlation between start grids
#col 2 = ratio
#col 3 = final/initial species 1
#col 4 = final/initial species 2
#col 5 = correlation between omega grids


extinctionmatsp1<- matrix(NA, nrow = nratios, ncol = nsims)
extinctionmatsp2<- matrix(NA, nrow = nratios, ncol = nsims)

## each collumn is the extinction time step for each simulation, 0 means it did not go extinct


for (i in 1:nratios){
  observ<- observvec[i] #sets population size of species 2
  print(observ)
  
  plottingmatrix1[i,4]<- observ
  
  temppoachers<- round(((nspecies1 * species1rev) + (nspecies2*species2rev))/poachval) #calculates number of poachers based on total revenue that is possible
  plottingmatrix1[i,5]<- temppoachers
  
  proportionleftsp1<- rep(NA, nsims)
  proportionleftsp2<- rep(NA, nsims)
  extinctionyrsp1<- rep(NA, nsims)
  extinctionyrsp2<- rep(NA, nsims)
  
  for(sim in 1:nsims){
    #set first seed
    set.seed(Binssubset[sim, 1])

    #generate omega grid
    Omega_grid1<- createomegagrid(Ngrid = numgrid, Nu = sample(x = seq(from = .0001, to = .8,
                                                                       length.out = 800),
                                                               size = 1))
    
    #set second seed
    set.seed(Binssubset[sim, 2])
    #generate omega grid
    Omega_grid2<-createomegagrid(Ngrid = numgrid, Nu = sample(x = seq(from = .0001, to = .8,
                                                                      length.out = 800),
                                                              size = 1))
    #reset seed
    set.seed(sim) #set seed back to a number unrelated to grid generation (this will be the same 500 seeds for all of the population ratios)
    
    temp<- multipletimesteps2species(Omega_gridsp1.fxn = Omega_grid1, Omega_gridsp2.fxn = Omega_grid2,
                                     Nanimalssp1.fxn = nspecies1, Nanimalssp2.fxn = nspecies2, Ngrid.fxn = 10,
                                     numberpoachers.fxn = temppoachers, nstep.fxn = nstep,
                                     rsp1.fxn = rsp1, rsp2.fxn = rsp2,
                                     variablec.fxn = varcost, fixedc.fxn = fixcost, revenuesp1.fxn = species1rev,
                                     revenuesp2.fxn = species2rev,
                                     prob1successsp1.fxn = psucc1, prob1successsp2.fxn = psucc2,
                                     sigmawsp1.fxn = 0, sigmawsp2.fxn = 0, 
                                     sigmav.fxn = observ, 
                                     selectivity.fxn = 1, Probleave1.fxn = 0.05, Probleave2.fxn = 0.05,
                                     ammocost.fxn = ammomoney, carrybackcost.fxn = carrybackmoney)
    proportionleftsp1[sim]<- sum(temp[[2]])/sum(temp[[1]])
    proportionleftsp2[sim]<- sum(temp[[4]])/sum(temp[[3]])
    extinctionyrsp1[sim]<- temp[[9]]
    extinctionyrsp2[sim]<- temp[[10]]
    
    
    correlationplot[(nsims*(i-1) + sim), 4]<- sum(temp[[4]])/sum(temp[[3]])
    correlationplot[(nsims*(i-1) + sim), 3]<- sum(temp[[2]])/sum(temp[[1]]) 
    #print(correlationplot[(nsims*(i-1) + sim), 3])
    correlationplot[(nsims*(i-1) + sim), 2]<- observ
    correlationplot[(nsims*(i-1) + sim), 1]<- cor(c(temp[[1]]), c(temp[[3]])) #correlaiton between starting grids not omega grids
    correlationplot[(nsims*(i-1) + sim), 5]<- cor(c(Omega_grid1), c(Omega_grid2))
  }
  allrunsfisp1[,i]<- proportionleftsp1
  allrunsfisp2[,i]<- proportionleftsp2
  
  
  extinctionmatsp1[i,]<- extinctionyrsp1
  extinctionmatsp2[i,]<- extinctionyrsp2
  plottingmatrix1[i, 2]<- mean(proportionleftsp1)
  plottingmatrix1[i, 3]<- mean(proportionleftsp2)
  plottingmatrix1[i, 6]<- sd(proportionleftsp1)
  plottingmatrix1[i, 7]<- sd(proportionleftsp2)
  plottingmatrix1[i, 8]<- quantile(proportionleftsp1, c(.5))
  plottingmatrix1[i, 9]<- quantile(proportionleftsp2, c(.5))
  plottingmatrix1[i, 10]<- quantile(proportionleftsp1, c(.025))
  plottingmatrix1[i, 11]<- quantile(proportionleftsp2, c(.025))
  plottingmatrix1[i, 12]<- quantile(proportionleftsp1, c(.975))
  plottingmatrix1[i, 13]<- quantile(proportionleftsp2, c(.975))
  
  
  
}


observplot<- plottingmatrix1
observcorr<- correlationplot
observext1<- extinctionmatsp1
observext2<- extinctionmatsp2
sp1allrun<- allrunsfisp1
sp2allrun<- allrunsfisp2

#add column names and write to file so that I have it saved

colnames(observplot)<- c("NA", "SP1 f/i", "SP2 f/i", "observ", "#poachers", "sd sp1",
                               "sd sp2", "med sp1", "med sp2", "sp1 lower ci", "sp2 lower ci", "sp1 upper ci", "sp2 upper ci")
write.table(observplot, file = "observplot", sep = " ",
            row.names = FALSE, col.names = TRUE)

colnames(observcorr)<- c("correlation between start grids", "observ",
                               "Sp1 f/i", "Sp2 f/i", "corelation between omega grids")
write.table(observcorr, file = "observcorr", sep = " ",
            row.names = FALSE, col.names = TRUE)


write.table(observext1, file = "observext1", sep = " ",
            row.names = FALSE, col.names = FALSE)

write.table(observext2, file = "observext2", sep = " ",
            row.names = FALSE, col.names = FALSE)


write.table(sp1allrun, file = "sp1allrun", sep = " ",
            row.names = FALSE, col.names = FALSE)
#rows are simulation 
#columns are the sensitivity

write.table(sp2allrun, file = "sp2allrun", sep = " ",
            row.names = FALSE, col.names = FALSE)
#rows are simulation 
#columns are the sensitivity
